<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="React 16.4 包含了一个 getDerivedStateFromProps 的 bugfix，这个 bug 导致一些 React 组件潜在的 bug 稳定复现。这个版本暴露了个案例，当你的应用正在使用反模式构建，则将会在此次修复后可能无法工作，我们对这个改动感到抱歉。在本文中，我们将阐述一些通常的使用 Derived State 的反模式以及相应的解决替代方案。
在很长一段时间，在 props 改变时响应 state 的更新，无需额外的渲染，唯一的途径就是 componentWillReceiveProps 这个生命周期方法。在 16.3 版本下，我们介绍了一个替代的生命周期 getDerivedStateFromProps 更加安全的方式来解决相同的用例。同时，我们意识到人们有很多关于使用这两个方法的错误解读，我们发现了这些反模式导致一些微妙且令人困惑的 bug。 getDerivedStateFromProps 在 16.4 中做了修复，使得 derived state 更加可预测，因此滥用的后果更加容易被留意到。 Note 所有关于旧的 &amp;gt; componentWillReceiveProps 和新 &amp;gt; getDerivedStateFromProps 的反模式都会在本文中阐述。 这篇文章涵盖以下话题：
什么时候使用 derived state
使用 derived state 时通常的 bug
反模式：无条件地将 prop 复制给 state
反模式：当 props 改变时清除 state
推荐的方案
什么是 memoization ？
什么时候使用 Derived State getDerivedStateFromProps 存在只为了一个目的。它让组件在 props 发生改变时更新它自身的内部 state。我们之前的文章提供一些例子，例如：基于 offset prop 的改变记录当前滚动位置或者 通过源 prop 加载外部数据。"><title>你可能不需要 Derived State</title><link rel=canonical href=https://edward40.com/posts/you-may-dont-need-drevied-state/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="你可能不需要 Derived State"><meta property="og:description" content="React 16.4 包含了一个 getDerivedStateFromProps 的 bugfix，这个 bug 导致一些 React 组件潜在的 bug 稳定复现。这个版本暴露了个案例，当你的应用正在使用反模式构建，则将会在此次修复后可能无法工作，我们对这个改动感到抱歉。在本文中，我们将阐述一些通常的使用 Derived State 的反模式以及相应的解决替代方案。
在很长一段时间，在 props 改变时响应 state 的更新，无需额外的渲染，唯一的途径就是 componentWillReceiveProps 这个生命周期方法。在 16.3 版本下，我们介绍了一个替代的生命周期 getDerivedStateFromProps 更加安全的方式来解决相同的用例。同时，我们意识到人们有很多关于使用这两个方法的错误解读，我们发现了这些反模式导致一些微妙且令人困惑的 bug。 getDerivedStateFromProps 在 16.4 中做了修复，使得 derived state 更加可预测，因此滥用的后果更加容易被留意到。 Note 所有关于旧的 &amp;gt; componentWillReceiveProps 和新 &amp;gt; getDerivedStateFromProps 的反模式都会在本文中阐述。 这篇文章涵盖以下话题：
什么时候使用 derived state
使用 derived state 时通常的 bug
反模式：无条件地将 prop 复制给 state
反模式：当 props 改变时清除 state
推荐的方案
什么是 memoization ？
什么时候使用 Derived State getDerivedStateFromProps 存在只为了一个目的。它让组件在 props 发生改变时更新它自身的内部 state。我们之前的文章提供一些例子，例如：基于 offset prop 的改变记录当前滚动位置或者 通过源 prop 加载外部数据。"><meta property="og:url" content="https://edward40.com/posts/you-may-dont-need-drevied-state/"><meta property="og:site_name" content="仕麟的博客"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="React"><meta property="article:published_time" content="2018-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2018-06-15T00:00:00+00:00"><meta property="og:image" content="https://edward40.com/posts/you-may-dont-need-drevied-state/react-derived-state.jpg"><meta name=twitter:title content="你可能不需要 Derived State"><meta name=twitter:description content="React 16.4 包含了一个 getDerivedStateFromProps 的 bugfix，这个 bug 导致一些 React 组件潜在的 bug 稳定复现。这个版本暴露了个案例，当你的应用正在使用反模式构建，则将会在此次修复后可能无法工作，我们对这个改动感到抱歉。在本文中，我们将阐述一些通常的使用 Derived State 的反模式以及相应的解决替代方案。
在很长一段时间，在 props 改变时响应 state 的更新，无需额外的渲染，唯一的途径就是 componentWillReceiveProps 这个生命周期方法。在 16.3 版本下，我们介绍了一个替代的生命周期 getDerivedStateFromProps 更加安全的方式来解决相同的用例。同时，我们意识到人们有很多关于使用这两个方法的错误解读，我们发现了这些反模式导致一些微妙且令人困惑的 bug。 getDerivedStateFromProps 在 16.4 中做了修复，使得 derived state 更加可预测，因此滥用的后果更加容易被留意到。 Note 所有关于旧的 &amp;gt; componentWillReceiveProps 和新 &amp;gt; getDerivedStateFromProps 的反模式都会在本文中阐述。 这篇文章涵盖以下话题：
什么时候使用 derived state
使用 derived state 时通常的 bug
反模式：无条件地将 prop 复制给 state
反模式：当 props 改变时清除 state
推荐的方案
什么是 memoization ？
什么时候使用 Derived State getDerivedStateFromProps 存在只为了一个目的。它让组件在 props 发生改变时更新它自身的内部 state。我们之前的文章提供一些例子，例如：基于 offset prop 的改变记录当前滚动位置或者 通过源 prop 加载外部数据。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://edward40.com/posts/you-may-dont-need-drevied-state/react-derived-state.jpg"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/kirito_hu9470a11a20a3a08d10a50c3f6b1883f5_79246_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🐱</span></figure><div class=site-meta><h1 class=site-name><a href=/>仕麟的博客</a></h1><h2 class=site-description>Great men are not born great, they grow great.</h2></div></header><ol class=social-menu><li><a href=https://github.com/sasuke40 target=_blank title=GitHub><svg width="256" height="250" viewBox="0 0 256 250" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"><g><path d="M128.00106.0C57.3172926.0.0 57.3066942.0 128.00106c0 56.554221 36.6761997 104.534482 87.534937 121.459839 6.3970853 1.18487999999999 8.745651-2.776734 8.745651-6.157566C96.280588 240.251045 96.1618878 230.167899 96.106777 219.472176 60.4967585 227.215235 52.9826207 204.369712 52.9826207 204.369712c-5.8226623-14.795114-14.2122127-18.729174-14.2122127-18.729174C27.1568785 177.696113 39.6458206 177.859325 39.6458206 177.859325 52.4993419 178.762293 59.267365 191.04987 59.267365 191.04987c11.4164025 19.568553 29.9442103 13.911223 37.2485035 10.640612C97.6647155 193.417512 100.981959 187.77078 104.642583 184.574357 76.211799 181.33766 46.324819 170.362144 46.324819 121.315702c0-13.974813 5.0002398-25.3933338 13.1884247-34.3573083-1.3290169-3.2239785-5.7103208-16.2428317 1.2399917-33.8740301.0.0 10.7487147-3.4401823 35.2094058 13.1205959 10.2103258-2.8360835 21.1604058-4.2583646 32.0384188-4.3071163C138.879073 61.9465949 149.837632 63.368876 160.067033 66.2049595c24.431017-16.5607782 35.164893-13.1205959 35.164893-13.1205959C202.199197 70.715562 197.815773 83.7344152 196.486756 86.9583937 204.694018 95.9223682 209.660343 107.340889 209.660343 121.315702c0 49.163023-29.94421 59.988045-58.447062 63.156912 4.591149 3.97221400000001 8.682061 11.761904 8.682061 23.703979.0 17.126724-.14837399999999 30.910768-.14837399999999 35.12674C159.746968 246.709601 162.05102 250.70089 168.53925 249.443941 219.370432 232.499507 256 184.536204 256 128.00106 256 57.3066942 198.691187.0 128.00106.0zM47.9405593 182.340212C47.6586465 182.976105 46.6581745 183.166873 45.7467277 182.730227 44.8183235 182.312656 44.2968914 181.445722 44.5978808 180.80771 44.8734344 180.152739 45.876026 179.97045 46.8023103 180.409216 47.7328342 180.826786 48.2627451 181.702199 47.9405593 182.340212zm6.2962299 5.618042C53.6263318 188.524199 52.4329723 188.261363 51.6232682 187.366874 50.7860088 186.474504 50.6291553 185.281144 51.2480912 184.70672 51.8776254 184.140775 53.0349512 184.405731 53.8743302 185.298101 54.7115892 186.201069 54.8748019 187.38595 54.2367892 187.958254zM58.5562413 195.146347C57.7719732 195.691096 56.4895886 195.180261 55.6968417 194.042013 54.9125733 192.903764 54.9125733 191.538713 55.713799 190.991845 56.5086651 190.444977 57.7719732 190.936735 58.5753181 192.066505 59.3574669 193.22383 59.3574669 194.58888 58.5562413 195.146347zM65.8613592 203.471174C65.1597571 204.244846 63.6654083 204.03712 62.5716717 202.981538 61.4524999 201.94927 61.1409122 200.484596 61.8446341 199.710926 62.5547146 198.935137 64.0575422 199.15346 65.1597571 200.200564 66.2704506 201.230712 66.6095936 202.705984 65.8613592 203.471174zM75.3025151 206.281542C74.9930474 207.284134 73.553809 207.739857 72.1039724 207.313809 70.6562556 206.875043 69.7087748 205.700761 70.0012857 204.687571 70.302275 203.678621 71.7478721 203.20382 73.2083069 203.659543 74.6539041 204.09619 75.6035048 205.261994 75.3025151 206.281542zM86.046947 207.473627C86.0829806 208.529209 84.8535871 209.404622 83.3316829 209.4237 81.8013 209.457614 80.563428 208.603398 80.5464708 207.564772c0-1.066181 1.20183800000001-1.93311500000002 2.7322209-1.958551C84.8005962 205.576546 86.046947 206.424403 86.046947 207.473627zM96.6021471 207.069023C96.7844366 208.099171 95.7267341 209.156872 94.215428 209.438785 92.7295577 209.710099 91.3539086 209.074206 91.1652603 208.052538 90.9808515 206.996955 92.0576306 205.939253 93.5413813 205.66582 95.054807 205.402984 96.4092596 206.021919 96.6021471 207.069023z" fill="#161614"/></g></svg></a></li><li><a href=mailto://sasuke688848@gmail.com target=_blank title=Gmail><svg width="256" height="193" viewBox="0 0 256 193" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"><g><path d="M58.1818182 192.049515V93.1404244L27.5066233 65.0770089.0 49.5040608V174.59497C0 184.253152 7.82545455 192.049515 17.4545455 192.049515H58.1818182z" fill="#4285f4"/><path d="M197.818182 192.049515h40.727273C248.203636 192.049515 256 184.224061 256 174.59497V49.5040608L224.844415 67.3422767 197.818182 93.1404244V192.049515z" fill="#34a853"/><polygon fill="#ea4335" points="58.1818182 93.1404244 54.0077618 54.4932827 58.1818182 17.5040608 128 69.8676972 197.818182 17.5040608 202.487488 52.4960089 197.818182 93.1404244 128 145.504061"/><path d="M197.818182 17.5040608V93.1404244L256 49.5040608V26.2313335c0-21.58545453-24.64-33.89090907-41.890909-20.94545453L197.818182 17.5040608z" fill="#fbbc04"/><path d="M0 49.5040608 26.7588051 69.5731646 58.1818182 93.1404244V17.5040608L41.8909091 5.28587897C24.6109091-7.65957557.0 4.64587897.0 26.2313335V49.5040608z" fill="#c5221f"/></g></svg></a></li><li><a href=https://t.me/edward40 target=_blank title=Telegram><svg width="256" height="256" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid"><title>Telegram</title><defs><linearGradient x1="50%" y1="277555756e-23%" x2="50%" y2="100%" id="telegramLinearGradient-1"><stop stop-color="#2aabee" offset="0"/><stop stop-color="#229ed9" offset="100%"/></linearGradient></defs><g><path d="M128 0C94.06.0 61.48 13.494 37.5 37.49 13.5 61.486.0 94.066.0 128s13.5 66.514 37.5 90.51C61.48 242.506 94.06 256 128 256s66.52-13.494 90.5-37.49c24-23.996 37.5-56.576 37.5-90.51s-13.5-66.514-37.5-90.51C194.52 13.494 161.94.0 128 0z" fill="url(#telegramLinearGradient-1)"/><path d="M57.94 126.6476c37.32-16.256 62.2-26.974 74.64-32.152 35.56-14.786 42.94-17.354 47.76-17.4408458C181.4 77.0376 183.76 77.2996 185.3 78.5456 186.58 79.5956 186.94 81.0156 187.12 82.0116 187.28 83.0076 187.5 85.2776 187.32 87.0496 185.4 107.2896 177.06 156.4056 172.82 179.0756 171.04 188.668 167.5 191.884 164.08 192.198 156.64 192.882 151 187.286 143.8 182.5676c-11.26-7.386-17.62-11.982-28.56-19.188C102.6 155.0516 110.8 150.4736 118 142.9936c1.88-1.958 34.64-31.748 35.26-34.45C153.34 108.2056 153.42 106.9456 152.66 106.2816 151.92 105.6156 150.82 105.8436 150.02 106.0236c-1.14000000000001.256-19.12 12.152-54 35.686C90.92 145.2176 86.3 146.9276 82.14 146.8376 77.58 146.7396 68.78 144.2536 62.24 142.1296 54.24 139.5236 47.86 138.1456 48.42 133.7196 48.7 131.4156 51.88 129.0576 57.94 126.6476z" fill="#fff"/></g></svg></a></li><li><a href=https://twitter.com/edward40e target=_blank title=Twitter><svg width="256" height="209" viewBox="0 0 256 209" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid"><g><path d="M256 25.4500259C246.580841 29.6272672 236.458451 32.4504868 225.834156 33.7202333c10.844347-6.500428 19.171674-16.7932404 23.093281-29.05715645C238.779765 10.6812633 227.539325 15.0523376 215.57599 17.408298 205.994835 7.2006971 192.34506.822 177.239197.822c-29.006592.0-52.523121 23.5155931-52.523121 52.5203116C124.716076 57.4586875 125.181462 61.4673784 126.076652 65.3112644 82.4258385 63.1210453 43.7257252 42.211429 17.821398 10.4359288c-4.5208969 7.757065-7.110955 16.7791946-7.110955 26.4043601.0 18.2212371 9.2730824 34.2972018 23.3657705 43.7154248C25.4660961 80.2832239 17.3681846 77.9207088 10.2862577 73.9869292 10.2825122 74.2060448 10.2825122 74.4260967 10.2825122 74.647085c0 25.447368 18.1041881 46.675358 42.1310508 51.499645C48.0059695 127.347184 43.3661509 127.988612 38.5755734 127.988612 35.1914554 127.988612 31.9009766 127.659938 28.694773 127.046602c6.6830243 20.866543 26.0794323 36.051063 49.0622188 36.475248-17.9749661 14.086133-40.6215882 22.482754-65.2280771 22.482754C8.28987161 186.004604 4.10888474 185.75646.0 185.271409c23.2431033 14.90173 50.8507261 23.596123 80.5109185 23.596123 96.6056105.0 149.4330585-80.03055 149.4330585-149.4349318C229.943977 57.1552968 229.893412 54.8901664 229.792282 52.6381454 240.053257 45.2331635 248.958338 35.9825545 256 25.4500259" fill="#55acee"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>主页</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜索</span></a></li><li><a href=/friends/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>朋友</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/you-may-dont-need-drevied-state/><img src=/posts/you-may-dont-need-drevied-state/react-derived-state_hu85a2256fecf81b989e856ffcf8306120_61133_800x0_resize_q75_box.jpg srcset="/posts/you-may-dont-need-drevied-state/react-derived-state_hu85a2256fecf81b989e856ffcf8306120_61133_800x0_resize_q75_box.jpg 800w, /posts/you-may-dont-need-drevied-state/react-derived-state_hu85a2256fecf81b989e856ffcf8306120_61133_1600x0_resize_q75_box.jpg 1600w" width=800 height=333 loading=lazy alt="Featured image of post 你可能不需要 Derived State"></a></div><div class=article-details><header class=article-category><a href=/categories/frontend/>Frontend</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/you-may-dont-need-drevied-state/>你可能不需要 Derived State</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 15, 2018</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 6 分钟</time></div></footer></div></header><section class=article-content><p>React 16.4 包含了一个  <a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/05/23/react-v-16-4.html%23bugfix-for-getderivedstatefromprops" target=_blank rel=noopener>getDerivedStateFromProps 的 bugfix</a>，这个 bug 导致一些 React 组件潜在的 bug 稳定复现。这个版本暴露了个案例，当你的应用正在使用反模式构建，则将会在此次修复后可能无法工作，我们对这个改动感到抱歉。在本文中，我们将阐述一些通常的使用 Derived State 的反模式以及相应的解决替代方案。</p><p>在很长一段时间，在 props 改变时响应 state 的更新，无需额外的渲染，唯一的途径就是  <code>componentWillReceiveProps</code>  这个生命周期方法。在 16.3 版本下，<a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/03/29/react-v-16-3.html%23component-lifecycle-changes" target=_blank rel=noopener>我们介绍了一个替代的生命周期 getDerivedStateFromProps</a>  更加安全的方式来解决相同的用例。同时，我们意识到人们有很多关于使用这两个方法的错误解读，我们发现了这些反模式导致一些微妙且令人困惑的 bug。 <code>getDerivedStateFromProps</code>  在 16.4 中做了修复，<a class=link href="https://link.zhihu.com/?target=https%3A//github.com/facebook/react/issues/12898" target=_blank rel=noopener>使得 derived state 更加可预测</a>，因此滥用的后果更加容易被留意到。
Note 
所有关于旧的  > <code>componentWillReceiveProps</code>  和新  > <code>getDerivedStateFromProps</code>  的反模式都会在本文中阐述。
这篇文章涵盖以下话题：</p><ul><li><p>什么时候使用 derived state</p></li><li><p>使用 derived state 时通常的 bug</p><ul><li><p>反模式：无条件地将 prop 复制给 state</p></li><li><p>反模式：当 props 改变时清除 state</p></li></ul></li><li><p>推荐的方案</p></li><li><p>什么是 memoization ？</p></li></ul><hr><h1 id=什么时候使用-derived-state>什么时候使用 Derived State</h1><p><code>getDerivedStateFromProps</code>  存在只为了一个目的。它让组件在  <strong>props 发生改变</strong>时更新它自身的内部 state。我们之前的文章提供一些例子，例如：<a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/03/27/update-on-async-rendering.html%23updating-state-based-on-props" target=_blank rel=noopener>基于 offset prop 的改变记录当前滚动位置</a>或者  <a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/03/27/update-on-async-rendering.html%23fetching-external-data-when-props-change" target=_blank rel=noopener>通过源 prop 加载外部数据</a>。</p><p>我们没有提供更多的例子，因为这有一个常规的准则，<strong>应该保守地使用 derived state</strong>。所有我们看到关于 derived state 的问题从根本上可以归结成两类：(1) 无条件的以 props 更新 state 或者 (2) 每当 props 和 state 不同时就更新 state。(我们将在下面谈到更多细节。)</p><ul><li><p>当你使用 derived state 来暂存一些仅基于当前 props 的计算结果时，你不需要 derived state。查看  <a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html%23what-about-memoization" target=_blank rel=noopener>什么是 memoization ?</a></p></li><li><p>当你无条件更新 derived state 抑或是每当 props 与 state 不同时更新 state，你的组件可能会频繁重置它的 state。</p></li></ul><hr><h1 id=使用-derived-state-时的常见-bug>使用 Derived State 时的常见 bug</h1><p>“受控的” 和 “不受控的” 这两个术语经常涉及到 form 的 input，然而他们也能描述组件数据存在的位置。当数据作为 props 传递时，则数据可以被认为是<strong>受控的</strong>(因为父组件<em>控制</em>了这些数据)。仅存在于内部 state 的数据可以被认为是<strong>不受控</strong>的(因为父组件不能直接改变它)。</p><p>derived state 的最常见错误就是混合了“受控”和“不受控”两种情况；当一个 derived state 值也使用  <code>setState</code>  来更新时，那它数据来源就不是唯一的。上文提到的“<a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/03/27/update-on-async-rendering.html%23fetching-external-data-when-props-change" target=_blank rel=noopener>外部数据加载的例子</a>”看上去好像就是这样，但其实有本质上差别。在数据加载例子中，&lsquo;source&rsquo; prop 和 &rsquo;loading&rsquo; state 都有明确的数据来源。当 &lsquo;source&rsquo; prop <strong>改变</strong>时， &rsquo;loading&rsquo; state <strong>总会</strong>被覆盖。相反地，state 当且仅当 prop 改变时才会被覆盖，否则只能被 state 所在的组件所管理。</p><p>当这些约束被改变时问题就浮现了。这会产生两个经典形式。让我们看一看他们。</p><h2 id=反模式无条件地将-prop-复制给-state>反模式：无条件地将 prop 复制给 state</h2><p>一个常见关于  <code>getDerivedStateFromProps</code>  和  <code>componentWillReceiveProps</code>  的错误理解就是他们只会在 props “变化”时调用。无论是组件重新渲染还是 props 和之前“不同”，这些生命周期方法都会被调用。基于此，这两个生命周期方法总是被用于不安全地无条件地覆盖 state。<strong>这样做将导致 state 的更新发生丢失。</strong></p><p>让我们思考一个例子来说明这个问题。这里有一个  <code>EmailInput</code>  组件“映射”了一个 email 属性在 state 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>EmailInput</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>email</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>email</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&lt;</span><span class=nx>input</span> <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>email</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>email</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>componentWillReceiveProps</span><span class=p>(</span><span class=nx>nextProps</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This will erase any local state updates!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Do not do this.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>email</span><span class=o>:</span> <span class=nx>nextProps</span><span class=p>.</span><span class=nx>email</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，这个组件看上去没什么问题。State 被 props 传递进来的值所初始化，并在我们键入  <code>&lt;input></code>  的时候被更新。但是如果我们的父组件重新渲染的时候，我们输入到  <code>input</code>  的内容就会丢失(<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/m3w9zn1z8x" target=_blank rel=noopener>看这个例子</a>)！即使我们在重置前进行比较  <code>nextProps.email !== this.state.email</code>也会这样。</p><p>在这个简单的例子中，只有当 email 属性被改变时加入  <code>shouldComponentUpdate</code>  来解决重渲染。然而在实践中，组件总是接受多个 props；另一个 prop 改变时依然会导致重渲染和不当重置。在函数和对象属性在内部被创建，在一个实质性的变化发生时，实现  <code>shouldComponentUpdate</code>  可靠地只返回 true 值变得困难。<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/jl0w6r9w59" target=_blank rel=noopener>这里有个 demo 展示发生的情况</a>。因此， <code>shouldComponentUpdate</code>  作为性能优化的最好方式被使用，而不用在 derived state 中保证正确性。</p><p>至此，为何<strong>无条件地将 props 复制给 state 是一个坏想法</strong>显而易见。在 review 可能的解决方案，让我们来看看一个有关的问题模式：在 email 属性改变时，如果我们只更新 state ？</p><h2 id=反模式当-props-改变时清除-state>反模式：当 props 改变时清除 state</h2><p>继续上述的例子，当  <code>props.email</code>  改变时，我们可以通过只更新来避免意外地清除 state：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>EmailInput</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>email</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>email</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>componentWillReceiveProps</span><span class=p>(</span><span class=nx>nextProps</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Any time props.email changes, update state.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>nextProps</span><span class=p>.</span><span class=nx>email</span> <span class=o>!==</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>email</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>email</span><span class=o>:</span> <span class=nx>nextProps</span><span class=p>.</span><span class=nx>email</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Note
不仅在以上例子中  > <code>componentWillReceiveProps</code> ,一个的反模式也被用于  > <code>getDerivedStateFromProps</code>  中。
我们做了很大的改进。现在我们的组件在 props 实质变化时才会清楚我们输入的内容。</p><p>但依旧存在一个微妙的问题。想象一下一个密码管理应用使用上述输入组件。当在两个相同 email 的账户下切换时，输入组件重置会失败。这是因为两个账户传递给组件的 prop 值是相同的！这使得用户感到诧异，一个账户没有保存的变更会影响另一个共享同一 email 的账号上。(<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/mz2lnkjkrx" target=_blank rel=noopener>这里看 demo</a>)</p><p>这种设计是有本质缺陷的，但它是最容易犯的。(<a class=link href="https://link.zhihu.com/?target=https%3A//twitter.com/brian_d_vaughn/status/959600888242307072" target=_blank rel=noopener>我就犯过！</a>)幸运的是，以下有两个更好的替代方案。而关键就是对每一片数据，你需要选一个控制数据并以其作为真实源的简单组件，并避免副本数据存在于其他组件。让我们来看一下这些替代方案。</p><hr><h1 id=优选方案>优选方案</h1><h2 id=推荐完全受控组件>推荐：完全受控组件</h2><p>一个避免上述涉及问题的途径就是完全地移除我们组件中的 state。如果 email 地址只存在于 prop，那我们没必要担心 state 的冲突。我们甚至可以把  <code>EmailInput</code>  缓存一个更加轻量的函数式的组件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>EmailInput</span><span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&lt;</span><span class=nx>input</span> <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>onChange</span><span class=p>}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=nx>props</span><span class=p>.</span><span class=nx>email</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个途径简化了我们组件的实现，但是我们如果想存储草稿的时候，父组件还是需要手工完成这件事。(<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/7154w1l551" target=_blank rel=noopener>点这看这种模式的例子</a>)</p><h2 id=推荐带有-key-的完全不受控组件>推荐：带有 key 的完全不受控组件</h2><p>另一个替代方案就是我们的组件完全的控制自己的 email state “草稿”。在此例子中，我们的组件依然可以接收一个来自于<em>初始值</em>，但它将会忽略后面 prop 的改动：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>EmailInput</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>email</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>defaultEmail</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>email</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&lt;</span><span class=nx>input</span> <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>email</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了能在不同的情境下重置值(如密码管理方案)，我们使用特殊的 React 属性  <code>key</code> 。当  <code>key</code>  改变时，React <a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/docs/reconciliation.html%23keys" target=_blank rel=noopener>将创建一个新的组件实例而不是更新现有的这个</a>。Keys 经常被用于动态 list，但在这里依然管用。在我们的案例中，我们能根据 user ID 在新用户被选中时重新创建 email 输入组件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>EmailInput</span> <span class=nx>defaultEmail</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>email</span><span class=p>}</span> <span class=nx>key</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>每当 ID 改变时， <code>EmailInput</code>  将会被重新创建，它的 state 将会用最新的  <code>defaultEmail</code>  值重置。(<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/6v1znlxyxn" target=_blank rel=noopener>点这里看这种模式的例子</a>)使用这种途径，你不需要为每一个输入组件加  <code>key</code> 。也许在 from 中加一个  <code>key</code>  会来得更好。每当 key 改变时，所有在 from 里的组件都会用一个新的 initialized state 来重新创建。</p><p>更多的案例中，这是一个处理需要被重置的 state 的最佳方式。
Note
虽然这貌似会很慢，在性能差异无关紧要的时候。当组件有很重的更新逻辑时候，使用一个 key ，忽略子树 diffing 甚至会更快。</p><h2 id=替代方案-1使用-id-prop-重置不受控组件>替代方案 1：使用 ID prop 重置不受控组件</h2><p>如果  <code>key</code>  由于某些原因不能被使用(也许组件有昂贵的初始化代价)，一个可行但笨重的方案就是在  <code>getDerivedStateFromProps</code>  中监听 “userID” 的改变：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>EmailInput</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>email</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>defaultEmail</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>prevPropsUserID</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>userID</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>getDerivedStateFromProps</span><span class=p>(</span><span class=nx>props</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Any time the current user changes,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Reset any parts of state that are tied to that user.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// In this simple example, that&#39;s just the email.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>props</span><span class=p>.</span><span class=nx>userID</span> <span class=o>!==</span> <span class=nx>state</span><span class=p>.</span><span class=nx>prevPropsUserID</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>prevPropsUserID</span><span class=o>:</span> <span class=nx>props</span><span class=p>.</span><span class=nx>userID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>email</span><span class=o>:</span> <span class=nx>props</span><span class=p>.</span><span class=nx>defaultEmail</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这也提供了灵活性——重置部分被我们选中的组件内部 state。(<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/rjyvp7l3rq" target=_blank rel=noopener>点这里看此模式的 demo</a>)
Note
及时以上例子展示了  > <code>getDerivedStateFromProps</code> ，同样的技术手段也可以被用在  > <code>componentWillReceiveProps</code> 。</p><h2 id=替代方式-2在一个实例方法中重置不受控组件>替代方式 2：在一个实例方法中重置不受控组件</h2><p>更罕见地，你可能需要重置 state 即使没有适当的 ID 可用为  <code>key</code> 。一个解决方案就是每次你想重置时用一个随机数或者自增数字重置 key。另一个可行的方案是暴露一个实例方法命令式的重置内部 state：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>EmailInput</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>email</span><span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>defaultEmail</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>resetEmailForNewUser</span><span class=p>(</span><span class=nx>newEmail</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>email</span><span class=o>:</span> <span class=nx>newEmail</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>父组件能<a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/docs/glossary.html%23refs" target=_blank rel=noopener>用 ref 来调用这个方法</a>。(<a class=link href="https://link.zhihu.com/?target=https%3A//codesandbox.io/s/l70krvpykl" target=_blank rel=noopener>点击这看这个模式例子</a>)</p><p>Refs 在这个确定的例子中是有用的，但通常上我们建议你保守使用。甚至在这个 demo 中，这个必要的方法是不理想的，因为本来一次的渲染会变成两次。</p><hr><h1 id=扼要重述>扼要重述</h1><p>重述一下，当设计一个组件的时候，决定数据是否受控或不受控是至关重要的。</p><p>让组件变得<strong>受控</strong>，而不是试图在** state 中复制一个 prop **，在一些父组件的 state 中联合两个分散的值。举个例子，与其子组件接收一个“已提交的” <code>props.value</code>  并跟踪一个“草稿” <code>state.value</code> ，不如在父组件中管理  <code>state.draftValue</code>  和  <code>state.committedValue</code> ，并控制直接控制子组件的值。这让数据流更加明确和可预测。</p><p>对<strong>不受控</strong>组件，如果你在一个特殊的 prop (通常是 ID)改变时试图重置 state，你有一些选择：</p><ul><li><p><strong>推荐：重置所有内部 state，使用 key 属性</strong></p></li><li><p>替代方案 1：<em>仅重置确定的 state 字段</em>，监听特定属性的变化(例如： <code>props.userID</code>)。</p></li><li><p>替代方案 2：你也可以考虑使用 refs 调用一个命令式实例方法。</p></li></ul><hr><h1 id=什么是-memoization->什么是 memoization ?</h1><p>我们也看到，仅当输入变化的时候，derived state 被用于确保关键值被用于  <code>render</code>  中会重新计算。这个技巧被称之为  <a class=link href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Memoization" target=_blank rel=noopener>memoization</a>。</p><p>使用 derived state 来完成 memoization 并不一定是坏事，但这经常不是最佳方案。管理 derived state 具有内在复杂度，这个复杂度随着属性的增加而提升。例如，如果我们想要加入第二个 derived feild 到我们的组件 state，那么我们的实现将需要分别跟踪两者的变化。</p><p>让我们来看一个例子——组件携带一个属性(一个 item list)，并渲染匹配用户输入的搜索查询的 item。我们使用 derived state 存储过滤的 list：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Example</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>filterText</span><span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// *******************************************************
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// NOTE: this example is NOT the recommended approach.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// See the examples below for our recommendations instead.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// *******************************************************
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>getDerivedStateFromProps</span><span class=p>(</span><span class=nx>props</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Re-run the filter whenever the list array or filter text change.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Note we need to store prevPropsList and prevFilterText to detect changes.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>props</span><span class=p>.</span><span class=nx>list</span> <span class=o>!==</span> <span class=nx>state</span><span class=p>.</span><span class=nx>prevPropsList</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=nx>state</span><span class=p>.</span><span class=nx>prevFilterText</span> <span class=o>!==</span> <span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>prevPropsList</span><span class=o>:</span> <span class=nx>props</span><span class=p>.</span><span class=nx>list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>prevFilterText</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>filteredList</span><span class=o>:</span> <span class=nx>props</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>          <span class=nx>item</span><span class=p>.</span><span class=nx>text</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>filterText</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>Fragment</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>input</span> <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>ul</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>filteredList</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>li</span> <span class=nx>key</span><span class=o>=</span><span class=p>{</span><span class=nx>item</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span><span class=o>&gt;</span><span class=p>{</span><span class=nx>item</span><span class=p>.</span><span class=nx>text</span><span class=p>}</span><span class=o>&lt;</span><span class=err>/li&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>))}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/ul&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/Fragment&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个实现避免了不必要  <code>filteredList</code>  的重新计算。但这比原来的更复杂，因为他必须分开跟踪和检测 props 和 state 的变化，才能正确更新过滤后的列表。在这个例子中，我们能使用  <code>PureComponent</code>  简化工作，移动更新操作到 render 方法中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// PureComponents only rerender if at least one state or prop value changes.
</span></span></span><span class=line><span class=cl><span class=c1>// Change is determined by doing a shallow comparison of state and prop keys.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>class</span> <span class=nx>Example</span> <span class=kr>extends</span> <span class=nx>PureComponent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// State only needs to hold the current filter text value:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>filterText</span><span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>filterText</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The render method on this PureComponent is called only if
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// props.list or state.filterText has changed.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>filteredList</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>item</span><span class=p>.</span><span class=nx>text</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>Fragment</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>input</span> <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>ul</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span><span class=nx>filteredList</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>li</span> <span class=nx>key</span><span class=o>=</span><span class=p>{</span><span class=nx>item</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span><span class=o>&gt;</span><span class=p>{</span><span class=nx>item</span><span class=p>.</span><span class=nx>text</span><span class=p>}</span><span class=o>&lt;</span><span class=err>/li&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>))}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/ul&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/Fragment&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这种途径比用 derived state 更加清晰且简单。偶尔地，这不够好——在大列表中过滤会变得慢，如果其他 prop 变化时  <code>PureComponent</code>  不会阻止重渲染。为了解决这些问题，我们可以加入一个 memoization helper 来避免对 list 的不必要过滤：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=nx>memoize</span> <span class=nx>from</span> <span class=s1>&#39;memoize-one&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Example</span> <span class=kr>extends</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// State only needs to hold the current filter text value:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>filterText</span><span class=o>:</span> <span class=s1>&#39;&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Re-run the filter whenever the list array or filter text changes:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>filter</span> <span class=o>=</span> <span class=nx>memoize</span><span class=p>((</span><span class=nx>list</span><span class=p>,</span> <span class=nx>filterText</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>list</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>text</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>filterText</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=nx>event</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>filterText</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Calculate the latest filtered list. If these arguments haven&#39;t changed
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// since the last render, `memoize-one` will reuse the last return value.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>filteredList</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>list</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>Fragment</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>input</span> <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>filterText</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>ul</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span><span class=nx>filteredList</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>li</span> <span class=nx>key</span><span class=o>=</span><span class=p>{</span><span class=nx>item</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span><span class=o>&gt;</span><span class=p>{</span><span class=nx>item</span><span class=p>.</span><span class=nx>text</span><span class=p>}</span><span class=o>&lt;</span><span class=err>/li&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>))}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/ul&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/Fragment&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这更加简单，而且性能和 derived state 版本的一样好！</p><p>当使用 memoization 时，记住一些约束条件：</p><ol><li><p>在大多数案例中，你会想把 memoized 函数附加到组件实例上。这防止一个组件的多个实例重置彼此的 memoized key。</p></li><li><p>通常地，你会想使用一个具有缓存大小限制的 memoization helper 来避免内存泄露问题。（在以上的例子中，我们用了  <code>memoize-one</code>  因为它仅缓存最近的参数和结果。）</p></li><li><p>如果  <code>props.list</code>  在每次父组件渲染时被重新创建，本节中展示的实现手段是无法工作的。但在多数案例中，这种设置是适当的。</p></li></ol><hr><h1 id=结语>结语</h1><p>在实际的应用中，组件经常包含受控和不受控行为的混合。这是没问题的！如果每一个值都有清晰的真实源，你可以避免上面提及的反模式。</p><p>同样值得重申的是， <code>getDerivedStateFromProps</code> (一般的 derived state) 是一个高级特性，由于其复杂度，应该保守的使用它。如果你使用的案例超出这些模式，请在  <a class=link href="https://link.zhihu.com/?target=https%3A//github.com/reactjs/reactjs.org/issues/new" target=_blank rel=noopener>Github</a>  或  <a class=link href="https://link.zhihu.com/?target=https%3A//twitter.com/reactjs" target=_blank rel=noopener>Twitter</a>  上与我们分享！</p><p>原文链接：<a class=link href="https://link.zhihu.com/?target=https%3A//reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html" target=_blank rel=noopener>You Probably Don&rsquo;t Need Derived State - React Blog</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/react/>React</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/compare-vue-composition-api-with-react-hooks/><div class=article-image><img src=/posts/compare-vue-composition-api-with-react-hooks/vue.b7df35f5df14059bbcce379a7d2bc494_huf4345b9185ae7551f6163dba18ba6799_23359_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 对比 Vue Composition API 和 React Hooks" data-key=compare-vue-composition-api-with-react-hooks data-hash="md5-t9819d8UBZu8zjeafSvElA=="></div><div class=article-details><h2 class=article-title>对比 Vue Composition API 和 React Hooks</h2></div></a></article><article class=has-image><a href=/posts/react-official-sample-explanation/><div class=article-image><img src=/posts/react-official-sample-explanation/react.5c28025533d676f6b16aba38e733b9da_huec1660347651d942a9c269942da33ff8_44423_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post React 官網示例講解" data-key=react-official-sample-explanation data-hash="md5-XCgCVTPWdvaxaro45zO52g=="></div><div class=article-details><h2 class=article-title>React 官網示例講解</h2></div></a></article><article class=has-image><a href=/posts/recoil-a-state-management-system-for-react/><div class=article-image><img src=/posts/recoil-a-state-management-system-for-react/_hu9a030952070e8277064d3c591128dc0a_924401_2c553633812ba04bba1996dd453f4b9e.png width=250 height=150 loading=lazy alt="Featured image of post Recoil 一个基于 actor 模型的 React 状态管理库" data-key=recoil-a-state-management-system-for-react data-hash="md5-UR8jdgksLR7/AjudaIreZg=="></div><div class=article-details><h2 class=article-title>Recoil 一个基于 actor 模型的 React 状态管理库</h2></div></a></article><article class=has-image><a href=/posts/a-guide-to-building-a-personal-website-with-gatsby/><div class=article-image><img src=/posts/a-guide-to-building-a-personal-website-with-gatsby/gatsby.2e27d10a334df94c6a21b765dd38005c_hu183bc92518a71c1132baa34e3b3f39ad_52039_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 使用 Gatsby 搭建个人网站指南" data-key=a-guide-to-building-a-personal-website-with-gatsby data-hash="md5-LifRCjNN+UxqIbdl3TgAXA=="></div><div class=article-details><h2 class=article-title>使用 Gatsby 搭建个人网站指南</h2></div></a></article><article class=has-image><a href=/posts/try-writing-fe-with-rust-yew/><div class=article-image><img src=/posts/try-writing-fe-with-rust-yew/yew.6bbca50ff9d2808584b41de3bbd77285_hu6ff4d2673b0a0137736822f776a015a8_53647_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 尝试用 Rust + Yew 写高性能前端页面" data-key=try-writing-fe-with-rust-yew data-hash="md5-a7ylD/nSgIWEtB3ju9dyhQ=="></div><div class=article-details><h2 class=article-title>尝试用 Rust + Yew 写高性能前端页面</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script>
<link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://unpkg.com/@waline/emojis@1.1.0/bmoji"],locale:{admin:"Admin",placeholder:null},requiredMeta:["name","email","url"],serverURL:"https://server.wilhelm.life:4343"})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 仕麟的博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#反模式无条件地将-prop-复制给-state>反模式：无条件地将 prop 复制给 state</a></li><li><a href=#反模式当-props-改变时清除-state>反模式：当 props 改变时清除 state</a></li></ol><ol><li><a href=#推荐完全受控组件>推荐：完全受控组件</a></li><li><a href=#推荐带有-key-的完全不受控组件>推荐：带有 key 的完全不受控组件</a></li><li><a href=#替代方案-1使用-id-prop-重置不受控组件>替代方案 1：使用 ID prop 重置不受控组件</a></li><li><a href=#替代方式-2在一个实例方法中重置不受控组件>替代方式 2：在一个实例方法中重置不受控组件</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>